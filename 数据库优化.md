# æ•°æ®åº“ä¼˜åŒ–åˆ†ææŠ¥å‘Š

## é¡¹ç›®æ¦‚è¿°
- **é¡¹ç›®åç§°**: ALCMS åç«¯ç³»ç»Ÿ
- **æ•°æ®åº“ç±»å‹**: PostgreSQL
- **æŠ€æœ¯æ ˆ**: Node.js + Express + pg (node-postgres)
- **åˆ†ææ—¥æœŸ**: 2025-09-11

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ALCMSé¡¹ç›®çš„æ•°æ®åº“è®¾è®¡å’ŒæŸ¥è¯¢æ€§èƒ½è¿›è¡Œäº†å…¨é¢åˆ†æï¼Œè¯†åˆ«äº†å¤šä¸ªä¼˜åŒ–æœºä¼šã€‚ç³»ç»Ÿæ•´ä½“è®¾è®¡è‰¯å¥½ï¼Œä½†åœ¨æŸ¥è¯¢æ€§èƒ½ã€ç´¢å¼•ç­–ç•¥å’Œæ‰©å±•æ€§æ–¹é¢å­˜åœ¨æ”¹è¿›ç©ºé—´ã€‚

### å…³é”®å‘ç°
- âœ… **ä¼˜åŠ¿**: è§„èŒƒçš„RBACæƒé™è®¾è®¡ã€å®Œæ•´çš„ç´¢å¼•è¦†ç›–ã€è‰¯å¥½çš„äº‹åŠ¡å¤„ç†
- âš ï¸ **æ”¹è¿›ç‚¹**: N+1æŸ¥è¯¢é—®é¢˜ã€ç¼ºå°‘å¤åˆç´¢å¼•ã€è¿æ¥æ± é…ç½®å¯ä¼˜åŒ–
- ğŸš¨ **é£é™©**: ç¼ºå°‘æŸ¥è¯¢æ€§èƒ½ç›‘æ§ã€æ— åˆ†åŒºç­–ç•¥ã€ç¼ºå°‘ç¼“å­˜å±‚

## 1. æ•°æ®åº“è¡¨ç»“æ„åˆ†æ

### 1.1 å½“å‰æ¶æ„è¯„ä¼°

#### æ ¸å¿ƒæ¨¡å—
1. **ç”¨æˆ·æƒé™ç³»ç»Ÿ** (RBACæ¨¡å‹)
   - users, roles, permissions, user_roles, role_permissions
   - è®¾è®¡è§„èŒƒï¼Œç¬¦åˆç¬¬ä¸‰èŒƒå¼
   
2. **å†…å®¹ç®¡ç†ç³»ç»Ÿ** (CMS)
   - resources, categories, tags, resource_tags
   - æ”¯æŒå¤šç±»å‹èµ„æºç®¡ç†
   
3. **ç¤¾åŒºç³»ç»Ÿ**
   - community_posts, community_comments, community_boards
   - æ”¯æŒå¤šçº§è¯„è®ºå’Œäº’åŠ¨
   
4. **å¢å€¼æœåŠ¡**
   - VIPç³»ç»Ÿã€ç§¯åˆ†ç³»ç»Ÿã€ç­¾åˆ°ç³»ç»Ÿ
   - å®Œæ•´çš„äº¤æ˜“è®°å½•è¿½è¸ª

### 1.2 è¡¨ç»“æ„ä¼˜åŒ–å»ºè®®

#### é«˜ä¼˜å…ˆçº§
```sql
-- 1. ä¸ºé«˜é¢‘æŸ¥è¯¢å­—æ®µæ·»åŠ å¤åˆç´¢å¼•
CREATE INDEX idx_resources_status_public_created 
ON resources(status, is_public, created_at DESC) 
WHERE status = 'published';

-- 2. ä¸ºç”¨æˆ·è¡¨æ·»åŠ éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–æ´»è·ƒç”¨æˆ·æŸ¥è¯¢
CREATE INDEX idx_users_active 
ON users(id, username, email) 
WHERE status = 'normal';

-- 3. ä¸ºç¤¾åŒºå¸–å­æ·»åŠ çƒ­åº¦æ’åºç´¢å¼•
CREATE INDEX idx_community_posts_hot 
ON community_posts(
  (view_count * 0.3 + reply_count * 0.5 + like_count * 0.2) DESC
) WHERE status = 'published';
```

#### ä¸­ä¼˜å…ˆçº§
```sql
-- 4. æ·»åŠ JSONBç´¢å¼•æ”¯æŒçµæ´»æŸ¥è¯¢
CREATE INDEX idx_checkin_configs_bonus_gin 
ON checkin_configs USING gin(consecutive_bonus);

-- 5. æ·»åŠ è¦†ç›–ç´¢å¼•å‡å°‘å›è¡¨
CREATE INDEX idx_user_checkins_covering 
ON user_checkins(user_id, checkin_date) 
INCLUDE (points_earned, consecutive_days, bonus_points);
```

## 2. SQLæŸ¥è¯¢æ€§èƒ½åˆ†æ

### 2.1 N+1æŸ¥è¯¢é—®é¢˜

#### é—®é¢˜å‘ç°
åœ¨ä»¥ä¸‹åœºæ™¯ä¸­å­˜åœ¨N+1æŸ¥è¯¢ï¼š

1. **èµ„æºåˆ—è¡¨åŠ è½½æ ‡ç­¾**
   ```javascript
   // å½“å‰å®ç° - Resource.js
   const resource = result.rows[0];
   // ç‹¬ç«‹æŸ¥è¯¢æ ‡ç­¾ - N+1é—®é¢˜
   const tagsResult = await query(
     `SELECT t.* FROM tags t
      JOIN resource_tags rt ON t.id = rt.tag_id
      WHERE rt.resource_id = $1`,
     [id]
   );
   ```

2. **ç¤¾åŒºå¸–å­æƒé™æ£€æŸ¥**
   - æ¯ä¸ªå¸–å­ç‹¬ç«‹æŸ¥è¯¢ç”¨æˆ·æƒé™
   - è¯„è®ºåŠ è½½æ—¶ç‹¬ç«‹æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯

#### ä¼˜åŒ–æ–¹æ¡ˆ
```javascript
// æ‰¹é‡é¢„åŠ è½½ä¼˜åŒ–
class ResourceOptimized {
  static async findAllWithTags(options) {
    // 1. è·å–èµ„æºåˆ—è¡¨
    const resources = await this.findAll(options);
    
    // 2. æ‰¹é‡åŠ è½½æ‰€æœ‰æ ‡ç­¾
    const resourceIds = resources.map(r => r.id);
    const allTags = await query(`
      SELECT rt.resource_id, t.*
      FROM tags t
      JOIN resource_tags rt ON t.id = rt.tag_id
      WHERE rt.resource_id = ANY($1)
    `, [resourceIds]);
    
    // 3. ç»„è£…æ•°æ®
    const tagsByResource = {};
    allTags.rows.forEach(tag => {
      if (!tagsByResource[tag.resource_id]) {
        tagsByResource[tag.resource_id] = [];
      }
      tagsByResource[tag.resource_id].push(tag);
    });
    
    // 4. åˆå¹¶ç»“æœ
    resources.forEach(resource => {
      resource.tags = tagsByResource[resource.id] || [];
    });
    
    return resources;
  }
}
```

### 2.2 å¤æ‚æŸ¥è¯¢ä¼˜åŒ–

#### ç¤¾åŒºå¸–å­åˆ—è¡¨æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä¼˜åŒ–å‰ï¼šå¤šä¸ªLEFT JOINå’Œå­æŸ¥è¯¢
-- ä¼˜åŒ–åï¼šä½¿ç”¨CTEå’Œçª—å£å‡½æ•°
WITH ranked_posts AS (
  SELECT 
    cp.*,
    ROW_NUMBER() OVER (
      PARTITION BY cp.board_id 
      ORDER BY cp.is_pinned DESC, cp.last_reply_time DESC
    ) as board_rank,
    COUNT(*) OVER (PARTITION BY cp.board_id) as board_total
  FROM community_posts cp
  WHERE cp.status = 'published'
),
post_tags AS (
  SELECT 
    post_id,
    json_agg(
      json_build_object('id', t.id, 'name', t.name)
    ) as tags
  FROM community_post_tags cpt
  JOIN tags t ON cpt.tag_id = t.id
  GROUP BY post_id
)
SELECT 
  rp.*,
  u.username,
  u.nickname,
  cb.display_name as board_name,
  COALESCE(pt.tags, '[]'::json) as tags
FROM ranked_posts rp
JOIN users u ON rp.author_id = u.id
JOIN community_boards cb ON rp.board_id = cb.id
LEFT JOIN post_tags pt ON rp.id = pt.post_id
WHERE rp.board_rank <= 20  -- æ¯ä¸ªæ¿å—æœ€å¤š20æ¡
ORDER BY rp.last_reply_time DESC;
```

## 3. æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–

### 3.1 å½“å‰é…ç½®åˆ†æ
```javascript
// å½“å‰é…ç½®
const pool = new Pool({
  max: 20,                    // æœ€å¤§è¿æ¥æ•°
  idleTimeoutMillis: 30000,   // 30ç§’ç©ºé—²è¶…æ—¶
  connectionTimeoutMillis: 2000,
  maxLifetimeSeconds: 60      // è¿æ¥ç”Ÿå‘½å‘¨æœŸ60ç§’
});
```

### 3.2 ä¼˜åŒ–å»ºè®®
```javascript
// ä¼˜åŒ–åé…ç½®
const pool = new Pool({
  // åŸºç¡€é…ç½®
  max: process.env.DB_POOL_MAX || 30,  // æé«˜æœ€å¤§è¿æ¥æ•°
  min: process.env.DB_POOL_MIN || 5,   // è®¾ç½®æœ€å°è¿æ¥æ•°
  
  // è¶…æ—¶é…ç½®
  idleTimeoutMillis: 60000,            // å»¶é•¿åˆ°60ç§’
  connectionTimeoutMillis: 5000,       // å»¶é•¿è¿æ¥è¶…æ—¶
  maxLifetimeSeconds: 1800,            // 30åˆ†é’Ÿç”Ÿå‘½å‘¨æœŸ
  
  // æ€§èƒ½é…ç½®
  statement_timeout: 30000,             // SQLè¯­å¥è¶…æ—¶30ç§’
  query_timeout: 30000,                // æŸ¥è¯¢è¶…æ—¶30ç§’
  
  // è¿æ¥æ± è¡Œä¸º
  allowExitOnIdle: false,              // ä¿æŒè¿›ç¨‹è¿è¡Œ
  maxUses: 7500,                       // å•è¿æ¥æœ€å¤§ä½¿ç”¨æ¬¡æ•°
});

// æ·»åŠ è¿æ¥æ± ç›‘æ§
pool.on('acquire', (client) => {
  console.log('Client acquired, pool size:', pool.totalCount);
});

pool.on('release', (err, client) => {
  if (err) {
    console.error('Error releasing client', err.stack);
  }
});

// å®šæœŸå¥åº·æ£€æŸ¥
setInterval(async () => {
  const metrics = {
    total: pool.totalCount,
    idle: pool.idleCount,
    waiting: pool.waitingCount,
  };
  console.log('Pool metrics:', metrics);
}, 60000);
```

## 4. äº‹åŠ¡å¤„ç†ä¼˜åŒ–

### 4.1 å½“å‰å®ç°è¯„ä¼°
ç³»ç»Ÿå·²å®ç°åŸºæœ¬çš„äº‹åŠ¡å¤„ç†ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š
- ç¼ºå°‘äº‹åŠ¡éš”ç¦»çº§åˆ«è®¾ç½®
- æ²¡æœ‰æ­»é”é‡è¯•æœºåˆ¶
- ç¼ºå°‘é•¿äº‹åŠ¡ç›‘æ§

### 4.2 æ”¹è¿›æ–¹æ¡ˆ
```javascript
class TransactionManager {
  // å¸¦é‡è¯•çš„äº‹åŠ¡æ‰§è¡Œ
  static async executeTransaction(callback, options = {}) {
    const {
      isolationLevel = 'READ COMMITTED',
      maxRetries = 3,
      retryDelay = 100
    } = options;
    
    let lastError;
    
    for (let i = 0; i < maxRetries; i++) {
      const client = await getClient();
      
      try {
        await client.query('BEGIN');
        await client.query(`SET TRANSACTION ISOLATION LEVEL ${isolationLevel}`);
        
        const result = await callback(client);
        
        await client.query('COMMIT');
        return result;
        
      } catch (error) {
        await client.query('ROLLBACK');
        lastError = error;
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¯é‡è¯•çš„é”™è¯¯
        if (this.isRetriableError(error)) {
          await new Promise(resolve => 
            setTimeout(resolve, retryDelay * Math.pow(2, i))
          );
          continue;
        }
        
        throw error;
      } finally {
        client.release();
      }
    }
    
    throw lastError;
  }
  
  static isRetriableError(error) {
    // PostgreSQLé”™è¯¯ä»£ç 
    const retriableCodes = [
      '40001', // serialization_failure
      '40P01', // deadlock_detected
      '55P03', // lock_not_available
    ];
    
    return retriableCodes.includes(error.code);
  }
}
```

## 5. æ•°æ®ä¸€è‡´æ€§å’Œå®Œæ•´æ€§

### 5.1 ç°çŠ¶è¯„ä¼°
âœ… **è‰¯å¥½å®è·µ**ï¼š
- å¤–é”®çº¦æŸå®Œæ•´
- ä½¿ç”¨è§¦å‘å™¨ç»´æŠ¤updated_at
- å”¯ä¸€æ€§çº¦æŸåˆç†

âš ï¸ **æ”¹è¿›ç©ºé—´**ï¼š
- ç¼ºå°‘CHECKçº¦æŸéªŒè¯
- æ²¡æœ‰æ•°æ®å®¡è®¡æ—¥å¿—
- ç¼ºå°‘è½¯åˆ é™¤æœºåˆ¶

### 5.2 å¢å¼ºæ–¹æ¡ˆ
```sql
-- 1. æ·»åŠ æ•°æ®éªŒè¯çº¦æŸ
ALTER TABLE users 
ADD CONSTRAINT check_email_format 
CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}$');

ALTER TABLE resources 
ADD CONSTRAINT check_points_range 
CHECK (required_points >= 0 AND required_points <= 999999);

-- 2. åˆ›å»ºå®¡è®¡æ—¥å¿—è¡¨
CREATE TABLE audit_logs (
  id BIGSERIAL PRIMARY KEY,
  table_name VARCHAR(50) NOT NULL,
  operation VARCHAR(10) NOT NULL,
  user_id INTEGER,
  record_id INTEGER,
  old_data JSONB,
  new_data JSONB,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_table_record 
ON audit_logs(table_name, record_id, created_at DESC);

-- 3. åˆ›å»ºé€šç”¨å®¡è®¡è§¦å‘å™¨
CREATE OR REPLACE FUNCTION audit_trigger_function()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO audit_logs (
    table_name, operation, user_id, record_id,
    old_data, new_data
  ) VALUES (
    TG_TABLE_NAME,
    TG_OP,
    current_setting('app.current_user_id', true)::INTEGER,
    COALESCE(NEW.id, OLD.id),
    to_jsonb(OLD),
    to_jsonb(NEW)
  );
  
  RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

-- åº”ç”¨åˆ°å…³é”®è¡¨
CREATE TRIGGER audit_users 
AFTER INSERT OR UPDATE OR DELETE ON users
FOR EACH ROW EXECUTE FUNCTION audit_trigger_function();
```

## 6. æ€§èƒ½ç›‘æ§å®æ–½

### 6.1 æŸ¥è¯¢æ€§èƒ½ç›‘æ§
```javascript
// åˆ›å»ºæ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
class QueryMonitor {
  static async monitorQuery(text, params, context = {}) {
    const start = Date.now();
    const startCPU = process.cpuUsage();
    
    try {
      const result = await query(text, params);
      const duration = Date.now() - start;
      const cpuUsage = process.cpuUsage(startCPU);
      
      // è®°å½•æ…¢æŸ¥è¯¢
      if (duration > 1000) {
        await this.logSlowQuery({
          query: text,
          params,
          duration,
          cpuUsage,
          context,
          rowCount: result.rowCount
        });
      }
      
      // æ›´æ–°ç»Ÿè®¡
      this.updateStats(text, duration);
      
      return result;
    } catch (error) {
      // è®°å½•é”™è¯¯æŸ¥è¯¢
      await this.logErrorQuery({
        query: text,
        params,
        error: error.message,
        context
      });
      
      throw error;
    }
  }
  
  static async logSlowQuery(data) {
    // å†™å…¥æ…¢æŸ¥è¯¢æ—¥å¿—è¡¨
    await query(`
      INSERT INTO slow_query_logs 
      (query_text, duration_ms, cpu_usage, context, created_at)
      VALUES ($1, $2, $3, $4, CURRENT_TIMESTAMP)
    `, [data.query, data.duration, data.cpuUsage, data.context]);
  }
}
```

### 6.2 å®æ—¶æ€§èƒ½ä»ªè¡¨æ¿
```sql
-- åˆ›å»ºæ€§èƒ½è§†å›¾
CREATE MATERIALIZED VIEW database_performance AS
WITH query_stats AS (
  SELECT 
    queryid,
    query,
    calls,
    total_exec_time,
    mean_exec_time,
    stddev_exec_time,
    rows
  FROM pg_stat_statements
  WHERE query NOT LIKE '%pg_stat%'
  ORDER BY total_exec_time DESC
  LIMIT 100
),
table_stats AS (
  SELECT 
    schemaname,
    tablename,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
  FROM pg_stat_user_tables
),
index_usage AS (
  SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
  FROM pg_stat_user_indexes
)
SELECT 
  'queries' as metric_type,
  json_build_object(
    'slow_queries', (SELECT json_agg(q) FROM query_stats q),
    'table_stats', (SELECT json_agg(t) FROM table_stats t),
    'index_usage', (SELECT json_agg(i) FROM index_usage i)
  ) as data,
  NOW() as created_at;

-- å®šæœŸåˆ·æ–°
CREATE OR REPLACE FUNCTION refresh_performance_view()
RETURNS void AS $$
BEGIN
  REFRESH MATERIALIZED VIEW CONCURRENTLY database_performance;
END;
$$ LANGUAGE plpgsql;
```

## 7. æ‰©å±•æ€§å’Œåˆ†åŒºç­–ç•¥

### 7.1 åˆ†åŒºç­–ç•¥å»ºè®®

#### æ—¶é—´åºåˆ—æ•°æ®åˆ†åŒº
```sql
-- 1. ç¤¾åŒºé€šçŸ¥è¡¨æŒ‰æœˆåˆ†åŒº
CREATE TABLE community_notifications_partitioned (
  LIKE community_notifications INCLUDING ALL
) PARTITION BY RANGE (created_at);

-- åˆ›å»ºåˆ†åŒº
CREATE TABLE community_notifications_2025_01 
PARTITION OF community_notifications_partitioned
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');

-- è‡ªåŠ¨åˆ†åŒºç®¡ç†å‡½æ•°
CREATE OR REPLACE FUNCTION create_monthly_partition()
RETURNS void AS $$
DECLARE
  start_date date;
  end_date date;
  partition_name text;
BEGIN
  start_date := date_trunc('month', CURRENT_DATE + interval '1 month');
  end_date := start_date + interval '1 month';
  partition_name := 'community_notifications_' || 
                   to_char(start_date, 'YYYY_MM');
  
  EXECUTE format(
    'CREATE TABLE IF NOT EXISTS %I PARTITION OF community_notifications_partitioned FOR VALUES FROM (%L) TO (%L)',
    partition_name, start_date, end_date
  );
END;
$$ LANGUAGE plpgsql;

-- è®¾ç½®å®šæ—¶ä»»åŠ¡
SELECT cron.schedule(
  'create-monthly-partitions',
  '0 0 25 * *',
  'SELECT create_monthly_partition()'
);
```

#### å¤§è¡¨å‚ç›´åˆ†åŒº
```sql
-- 2. èµ„æºè¡¨å‚ç›´åˆ†åŒºï¼ˆåˆ†ç¦»å¤§å­—æ®µï¼‰
CREATE TABLE resource_contents (
  resource_id INTEGER PRIMARY KEY REFERENCES resources(id),
  content TEXT,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- è¿ç§»æ•°æ®
INSERT INTO resource_contents (resource_id, content)
SELECT id, content FROM resources;

-- ä¿®æ”¹åŸè¡¨
ALTER TABLE resources DROP COLUMN content;
```

### 7.2 è¯»å†™åˆ†ç¦»æ¶æ„
```javascript
// å®ç°è¯»å†™åˆ†ç¦»
class DatabaseCluster {
  constructor() {
    // ä¸»åº“ï¼ˆå†™ï¼‰
    this.master = new Pool({
      host: process.env.MASTER_DB_HOST,
      ...masterConfig
    });
    
    // ä»åº“æ± ï¼ˆè¯»ï¼‰
    this.slaves = [
      new Pool({ host: process.env.SLAVE1_DB_HOST, ...slaveConfig }),
      new Pool({ host: process.env.SLAVE2_DB_HOST, ...slaveConfig })
    ];
    
    this.currentSlave = 0;
  }
  
  // å†™æ“ä½œä½¿ç”¨ä¸»åº“
  async write(text, params) {
    return this.master.query(text, params);
  }
  
  // è¯»æ“ä½œè´Ÿè½½å‡è¡¡åˆ°ä»åº“
  async read(text, params) {
    const slave = this.slaves[this.currentSlave];
    this.currentSlave = (this.currentSlave + 1) % this.slaves.length;
    return slave.query(text, params);
  }
  
  // äº‹åŠ¡å¿…é¡»åœ¨ä¸»åº“
  async getTransactionClient() {
    return this.master.connect();
  }
}
```

## 8. ç¼“å­˜ç­–ç•¥å®æ–½

### 8.1 å¤šçº§ç¼“å­˜æ¶æ„
```javascript
// Redisç¼“å­˜å±‚å®ç°
const Redis = require('ioredis');
const redis = new Redis({
  host: process.env.REDIS_HOST,
  port: process.env.REDIS_PORT,
  db: 0
});

class CacheLayer {
  // L1: è¿›ç¨‹å†…å­˜ç¼“å­˜
  static memoryCache = new Map();
  static memoryCacheTTL = 60; // 60ç§’
  
  // L2: Redisç¼“å­˜
  static async get(key, fetcher, options = {}) {
    const { ttl = 300, useMemory = true } = options;
    
    // æ£€æŸ¥L1ç¼“å­˜
    if (useMemory && this.memoryCache.has(key)) {
      const cached = this.memoryCache.get(key);
      if (cached.expires > Date.now()) {
        return cached.data;
      }
      this.memoryCache.delete(key);
    }
    
    // æ£€æŸ¥L2ç¼“å­˜
    const redisData = await redis.get(key);
    if (redisData) {
      const data = JSON.parse(redisData);
      
      // å†™å…¥L1ç¼“å­˜
      if (useMemory) {
        this.memoryCache.set(key, {
          data,
          expires: Date.now() + this.memoryCacheTTL * 1000
        });
      }
      
      return data;
    }
    
    // ä»æ•°æ®åº“è·å–
    const data = await fetcher();
    
    // å†™å…¥ç¼“å­˜
    await redis.setex(key, ttl, JSON.stringify(data));
    
    if (useMemory) {
      this.memoryCache.set(key, {
        data,
        expires: Date.now() + this.memoryCacheTTL * 1000
      });
    }
    
    return data;
  }
  
  // ç¼“å­˜å¤±æ•ˆ
  static async invalidate(patterns) {
    // æ¸…é™¤L1ç¼“å­˜
    for (const key of this.memoryCache.keys()) {
      if (patterns.some(p => key.includes(p))) {
        this.memoryCache.delete(key);
      }
    }
    
    // æ¸…é™¤L2ç¼“å­˜
    for (const pattern of patterns) {
      const keys = await redis.keys(pattern);
      if (keys.length > 0) {
        await redis.del(...keys);
      }
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
class ResourceService {
  static async getResource(id) {
    return CacheLayer.get(
      `resource:${id}`,
      () => Resource.findById(id),
      { ttl: 600 }
    );
  }
  
  static async updateResource(id, data) {
    const result = await Resource.update(id, data);
    
    // æ¸…é™¤ç›¸å…³ç¼“å­˜
    await CacheLayer.invalidate([
      `resource:${id}`,
      `resources:list:*`
    ]);
    
    return result;
  }
}
```

## 9. å…·ä½“ä¼˜åŒ–å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼ˆç«‹å³å®æ–½ï¼‰
1. **ç´¢å¼•ä¼˜åŒ–** - æ·»åŠ å¤åˆç´¢å¼•å’Œè¦†ç›–ç´¢å¼•
2. **è¿æ¥æ± è°ƒä¼˜** - æ›´æ–°é…ç½®å‚æ•°
3. **æŸ¥è¯¢ç›‘æ§** - éƒ¨ç½²æ…¢æŸ¥è¯¢æ—¥å¿—

### ç¬¬äºŒé˜¶æ®µï¼ˆ1-2å‘¨ï¼‰
1. **N+1æŸ¥è¯¢ä¿®å¤** - å®ç°æ‰¹é‡é¢„åŠ è½½
2. **äº‹åŠ¡ä¼˜åŒ–** - æ·»åŠ é‡è¯•æœºåˆ¶
3. **åŸºç¡€ç¼“å­˜** - éƒ¨ç½²Redisç¼“å­˜å±‚

### ç¬¬ä¸‰é˜¶æ®µï¼ˆ1ä¸ªæœˆï¼‰
1. **åˆ†åŒºå®æ–½** - å¯¹å¤§è¡¨è¿›è¡Œåˆ†åŒº
2. **è¯»å†™åˆ†ç¦»** - éƒ¨ç½²ä¸»ä»æ¶æ„
3. **æ€§èƒ½æµ‹è¯•** - å…¨é¢çš„è´Ÿè½½æµ‹è¯•

## 10. æ€§èƒ½åŸºå‡†å’Œé¢„æœŸæ”¶ç›Š

### é¢„æœŸæ€§èƒ½æå‡
- æŸ¥è¯¢å“åº”æ—¶é—´ï¼šé™ä½ 40-60%
- æ•°æ®åº“è¿æ¥ä½¿ç”¨ï¼šä¼˜åŒ– 30%
- N+1æŸ¥è¯¢æ¶ˆé™¤ï¼šå‡å°‘ 80% æ•°æ®åº“è°ƒç”¨
- ç¼“å­˜å‘½ä¸­ç‡ï¼šè¾¾åˆ° 70%+

### ç›‘æ§æŒ‡æ ‡
```sql
-- åˆ›å»ºæ€§èƒ½åŸºå‡†è¡¨
CREATE TABLE performance_baselines (
  id SERIAL PRIMARY KEY,
  metric_name VARCHAR(100),
  baseline_value NUMERIC,
  current_value NUMERIC,
  improvement_percent NUMERIC,
  measured_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å®šæœŸæ”¶é›†æŒ‡æ ‡
INSERT INTO performance_baselines (metric_name, baseline_value, current_value)
SELECT 
  'avg_query_time',
  1.5, -- åŸºå‡†å€¼ï¼ˆæ¯«ç§’ï¼‰
  (SELECT avg(mean_exec_time) FROM pg_stat_statements)
UNION ALL
SELECT 
  'slow_query_count',
  100, -- åŸºå‡†å€¼
  (SELECT count(*) FROM pg_stat_statements WHERE mean_exec_time > 1000)
UNION ALL
SELECT 
  'cache_hit_ratio',
  0.85, -- åŸºå‡†å€¼
  (SELECT sum(blks_hit)::float / (sum(blks_hit) + sum(blks_read)) 
   FROM pg_stat_database WHERE datname = current_database());
```

## æ€»ç»“

æœ¬æ¬¡æ•°æ®åº“ä¼˜åŒ–åˆ†æè¯†åˆ«äº†å¤šä¸ªå…³é”®æ”¹è¿›é¢†åŸŸã€‚é€šè¿‡å®æ–½å»ºè®®çš„ä¼˜åŒ–ç­–ç•¥ï¼Œé¢„è®¡å¯ä»¥æ˜¾è‘—æå‡ç³»ç»Ÿæ€§èƒ½å’Œå¯æ‰©å±•æ€§ã€‚å»ºè®®æŒ‰ç…§å®æ–½è®¡åˆ’åˆ†é˜¶æ®µè¿›è¡Œä¼˜åŒ–ï¼Œå¹¶æŒç»­ç›‘æ§æ€§èƒ½æŒ‡æ ‡ä»¥éªŒè¯æ”¹è¿›æ•ˆæœã€‚

### å…³é”®è¡ŒåŠ¨é¡¹
1. ç«‹å³æ·»åŠ ç¼ºå¤±çš„å¤åˆç´¢å¼•
2. ä¿®å¤è¯†åˆ«çš„N+1æŸ¥è¯¢é—®é¢˜
3. å®æ–½æŸ¥è¯¢æ€§èƒ½ç›‘æ§
4. éƒ¨ç½²ç¼“å­˜å±‚
5. è§„åˆ’é•¿æœŸçš„åˆ†åŒºå’Œæ‰©å±•ç­–ç•¥

### é£é™©ç¼“è§£
- åœ¨ç”Ÿäº§ç¯å¢ƒå®æ–½å‰è¿›è¡Œå……åˆ†æµ‹è¯•
- å®æ–½å›æ»šè®¡åˆ’
- é€æ­¥æ¨è¿›ï¼Œç›‘æ§æ¯æ­¥çš„å½±å“
- ä¿æŒæ•°æ®åº“å¤‡ä»½ç­–ç•¥

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: 2025-09-11*
*åˆ†æå·¥å…·: PostgreSQL EXPLAIN ANALYZE, pg_stat_statements*
*å»ºè®®å¤æŸ¥å‘¨æœŸ: æ¯å­£åº¦*